generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model User {
  id                 String           @id @default(cuid())
  name               String?
  email              String?          @unique
  emailVerified      DateTime?
  image              String?
  password           String?
  role               String           @default("CLIENT")
  isActive           Boolean          @default(true)
  lastLoginAt        DateTime?
  societyAccountId   String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  subscriptionEndsAt DateTime?
  trialEndsAt        DateTime?
  expiryDate         DateTime?
  plan               String?
  subscriptionStatus String?
  accounts           Account[]
  paymentProofs      PaymentProof[]
  pendingPayments    PendingPayment[]
  posts              Post[]
  sessions           Session[]
  societyAccount     SocietyAccount?  @relation(fields: [societyAccountId], references: [id])

  @@index([role])
  @@index([isActive])
  @@index([subscriptionStatus])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model SocietyAccount {
  id                 String    @id @default(uuid())
  name               String
  adminName          String?
  email              String    @unique
  phone              String?
  address            String?
  subscriptionPlan   String    @default("TRIAL")
  status             String    @default("TRIAL")
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  users              User[]

  @@map("society_accounts")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model Society {
  id               String   @id @default(uuid())
  name             String
  description      String?
  address          String?
  phone            String?
  email            String?
  societyAccountId String
  createdByUserId  String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("societies")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model Post {
  id        String   @id @default(uuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [authorId], references: [id])

  @@map("posts")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model AutomationTask {
  id              String    @id @default(uuid())
  task_name       String    @unique
  description     String?
  schedule        String?   @default("manual")
  enabled         Boolean?  @default(true)
  last_run_status String?
  last_run_at     DateTime? @default(now())
  created_at      DateTime? @default(now())

  @@map("automation_tasks")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model PaymentProof {
  id            String   @id @default(cuid())
  userId        String
  amount        Float
  plan          String
  transactionId String   @unique
  screenshotUrl String?
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("payment_proofs")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model PendingPayment {
  id              String   @id @default(cuid())
  userId          String
  plan            String
  transactionId   String   @unique
  amount          Float
  status          String   @default("pending")
  screenshotUrl   String?
  adminNotes      String?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("pending_payments")
}

/// /////////////////////////////////////////////////
/// SYSTEM SETTINGS
/// /////////////////////////////////////////////////
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

/// /////////////////////////////////////////////////
/// /////////////////////////////////////////////////
model AutomationLog {
  id          String    @id @default(uuid())
  task_name   String?
  status      String
  message     String?
  details     Json?
  duration_ms Int?
  run_time    DateTime? @default(now())

  @@map("automation_logs")
}

/// 1. Members (Root Table)
model Member {
  id          String          @id @default(uuid())
  name        String
  phone       String?
  address     String?
  joiningDate DateTime        @default(now())
  status      String          @default("active")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  loans       Loan[]
  passbook    PassbookEntry[]
  notifications Notification[]
  maturityRecords MaturityRecord[]

  @@index([status])
  @@index([joiningDate])
  @@map("members")
}

/// 2. Loans
model Loan {
  id               String          @id @default(uuid())
  memberId         String
  loanAmount       Float
  interestRate     Float           @default(1.0)
  loanDate         DateTime        @default(now())
  nextDueDate      DateTime
  status           String          @default("active")
  remainingBalance Float
  overrideEnabled  Boolean         @default(false)
  description      String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  member           Member          @relation(fields: [memberId], references: [id], onDelete: Cascade)
  passbookEntries  PassbookEntry[]

  @@index([memberId])
  @@index([status])
  @@index([nextDueDate])
  @@map("loans")
}

/// 3. Passbook
model PassbookEntry {
  id              String   @id @default(uuid())
  memberId        String
  depositAmount   Float?
  loanInstallment Float?
  interestAuto    Float?
  fineAuto        Float?
  mode            String
  loanRequestId   String?
  transactionDate DateTime @default(now())
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  member          Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  loan            Loan?    @relation(fields: [loanRequestId], references: [id])

  @@index([memberId])
  @@index([transactionDate])
  @@index([mode])
  @@map("passbook_entries")
}

/// 4. Expenses
model Expense {
  id          String   @id @default(uuid())
  title       String
  amount      Float
  mode        String
  date        DateTime @default(now())
  type        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([date])
  @@map("expenses")
}

/// 5. Admin Fund (Personal balance ledger)
model AdminFund {
  id                 String   @id @default(uuid())
  fundIn             Float?
  fundOut            Float?
  description        String?
  transactionDate    DateTime @default(now())
  remainingBalance   Float
  mustClearWithin3Yr Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([transactionDate])
  @@map("admin_funds")
}

/// 6. Notifications
model Notification {
  id          String   @id @default(uuid())
  memberId    String
  title       String
  message     String
  type        String   @default("general")
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([read])
  @@index([type])
  @@map("notifications")
}

/// 7. Maturity Records
model MaturityRecord {
  id                    String    @id @default(uuid())
  memberId              String
  totalDeposit          Float
  startDate             DateTime
  maturityDate          DateTime
  monthsCompleted       Int       @default(0)
  remainingMonths       Int       @default(36)
  monthlyInterestRate   Float     @default(0.0333333333)
  currentInterest       Float     @default(0)
  fullInterest          Float     @default(0)
  manualOverride        Boolean   @default(false)
  adjustedInterest      Float?
  currentAdjustment     Float     @default(0)
  loanAdjustment        Float     @default(0)
  status                String    @default("active") // active | matured | claimed
  claimedAt             DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  member                Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([status])
  @@index([maturityDate])
  @@index([startDate])
  @@map("maturity_records")
}
